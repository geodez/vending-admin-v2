# Vending Admin v2 - Архитектура проекта

**Версия документации:** Обновлена 2026-01-24 (после рефакторинга)  
**Версия проекта:** v1.1.1  
**Статус:** Актуальная реализация

---

## 🎯 Цель проекта

Современная административная панель для управления вендинговым бизнесом с аутентификацией через Telegram и полным функционалом для:
- Собственников (полный доступ к финансам и управлению)
- Операторов (доступ к оперативному управлению)

---

## 📝 Важные примечания

⚠️ **Эта документация обновлена после рефакторинга и отражает актуальную реализацию.**

- Структура файлов может отличаться от первоначального плана (модули объединены)
- Пути API endpoints обновлены (более структурированы)
- RBAC упрощен (без таблиц permissions)
- Некоторые функции из первоначальной документации не реализованы (см. `IMPROVEMENT_PLAN.md`)

---

## 🏗️ Общая архитектура

```
┌─────────────────────────────────────────────────────────────┐
│                    Telegram Mini App                         │
│              (React + TypeScript + Vite)                     │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ├── Telegram WebApp API (auth)
                        │
                        ↓
┌─────────────────────────────────────────────────────────────┐
│                   FastAPI Backend                            │
│   • REST API                                                 │
│   • Telegram Auth Middleware                                │
│   • Role-Based Access Control (RBAC)                        │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ↓
┌─────────────────────────────────────────────────────────────┐
│              PostgreSQL Database                             │
│   • Пользователи и роли                                     │
│   • Данные Vendista (синхронизация)                        │
│   • Бизнес-логика (рецепты, склад, расходы)               │
└─────────────────────────────────────────────────────────────┘
                        ↑
                        │
┌───────────────────────┴─────────────────────────────────────┐
│              Vendista API (внешний источник)                │
│   • Транзакции                                              │
│   • Данные терминалов                                       │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔐 Аутентификация через Telegram

### Принцип работы

1. **Пользователь открывает Telegram Mini App**
   - Приложение получает `window.Telegram.WebApp.initData`
   - Данные содержат: `user.id`, `user.username`, `user.first_name`, `auth_date`, `hash`

2. **Валидация на бэкенде**
   ```python
   # FastAPI middleware проверяет:
   # 1. Подлинность данных через hash (HMAC-SHA256)
   # 2. Срок действия auth_date (не старше 24 часов)
   # 3. Наличие пользователя в базе
   ```

3. **JWT Token выдача**
   ```python
   # После успешной валидации:
   # 1. Проверяем user_id в таблице users
   # 2. Выдаем JWT token с claims: user_id, role, permissions
   # 3. Frontend сохраняет токен и использует для API запросов
   ```

### Схема БД для пользователей

```sql
-- Таблица пользователей
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    telegram_user_id BIGINT UNIQUE NOT NULL,
    username TEXT,
    first_name TEXT,
    last_name TEXT,
    role TEXT NOT NULL DEFAULT 'operator',  -- 'owner', 'operator'
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ⚠️ УПРОЩЕННЫЙ RBAC: Таблицы permissions не используются
-- Права доступа определяются только полем role в таблице users
-- Роли: 'owner' (полный доступ) и 'operator' (ограниченный доступ)
-- Проверка прав выполняется через декоратор require_owner в deps.py
```

### Права доступа по ролям

**Собственник (Owner)**
- ✅ Просмотр всех разделов
- ✅ Редактирование всех данных
- ✅ Просмотр финансовых отчетов
- ✅ Управление пользователями
- ✅ Настройки системы

**Оператор (Operator)**
- ✅ Просмотр: Обзор, Продажи, Склад
- ✅ Редактирование: Рецепты, Ингредиенты, Кнопки терминала
- ✅ Ввод: Переменные расходы, Загрузки склада
- ❌ Финансовые отчеты (Отчет собственника)
- ❌ Управление пользователями
- ❌ Настройки системы

---

## 🖥️ Backend Architecture (FastAPI)

### Структура проекта

```
backend/
├── app/
│   ├── __init__.py
│   ├── main.py                    # FastAPI app entry point
│   ├── config.py                  # Settings (Pydantic Settings)
│   │
│   ├── auth/
│   │   ├── __init__.py
│   │   ├── telegram.py           # Telegram auth validation
│   │   └── jwt.py                # JWT token generation/validation
│   │
│   ├── api/
│   │   ├── __init__.py
│   │   ├── deps.py               # API dependencies (get_current_user, require_owner)
│   │   ├── middleware/           # ⭐ Новое после рефакторинга
│   │   │   ├── error_handlers.py # Централизованная обработка ошибок
│   │   │   └── validation.py    # Валидация и общие паттерны
│   │   └── v1/
│   │       ├── __init__.py
│   │       ├── auth.py           # POST /auth/telegram, GET /auth/me
│   │       ├── analytics.py      # ⭐ Объединяет overview, sales, owner-report
│   │       ├── business.py       # ⭐ Агрегатор бизнес-модулей
│   │       ├── drinks.py          # ⭐ CRUD рецептов (вместо recipes.py)
│   │       ├── ingredients.py    # ⭐ CRUD ингредиентов
│   │       ├── locations.py      # ⭐ CRUD локаций
│   │       ├── products.py       # ⭐ CRUD продуктов
│   │       ├── inventory.py      # ⭐ Управление складом
│   │       ├── mapping.py        # ⭐ Маппинг кнопок терминалов (Button Matrix)
│   │       ├── expenses.py       # CRUD переменных расходов
│   │       ├── users.py          # ⭐ Управление пользователями (вместо settings.py)
│   │       ├── terminals.py      # CRUD терминалов
│   │       ├── transactions.py  # CRUD транзакций
│   │       └── sync.py           # Синхронизация с Vendista
│   │
│   ├── models/
│   │   ├── __init__.py
│   │   ├── user.py               # User model (упрощенный RBAC)
│   │   ├── business.py           # ⭐ Объединяет: Location, Product, Drink, Ingredient, ButtonMatrix
│   │   ├── inventory.py          # ⭐ Объединяет: IngredientLoad, VariableExpense
│   │   └── vendista.py           # ⭐ Объединяет: VendistaTerminal, VendistaTx, SyncRun
│   │
│   ├── schemas/
│   │   ├── __init__.py
│   │   ├── auth.py               # TelegramAuthRequest, TokenResponse
│   │   ├── business.py           # ⭐ Объединяет схемы для всех бизнес-сущностей
│   │   └── vendista.py           # ⭐ Схемы для Vendista данных
│   │
│   ├── crud/
│   │   ├── __init__.py
│   │   ├── user.py               # CRUD для пользователей
│   │   ├── business.py           # ⭐ Объединяет CRUD для всех бизнес-сущностей
│   │   └── vendista.py           # ⭐ CRUD для Vendista данных
│   │
│   ├── db/
│   │   ├── __init__.py
│   │   ├── session.py            # SQLAlchemy session
│   │   └── base.py               # Base model
│   │
│   └── services/                 # ⭐ Новое после рефакторинга
│       ├── __init__.py
│       ├── vendista_sync.py      # Синхронизация с Vendista API
│       ├── vendista_client.py   # HTTP клиент для Vendista API
│       ├── ingredient_service.py # ⭐ Бизнес-логика ингредиентов
│       ├── recipe_service.py     # ⭐ Бизнес-логика рецептов
│       └── expense_service.py    # ⭐ Бизнес-логика расходов
│
├── migrations/                    # Alembic migrations
├── tests/
│   ├── unit/                     # Unit тесты
│   │   └── test_services.py      # ⭐ Тесты сервисов
│   └── integration/              # ⭐ Интеграционные тесты
│       └── test_business_endpoints.py
├── requirements.txt
├── Dockerfile
└── docker-compose.yml
```

**Примечания:**
- ⭐ Помечены компоненты, добавленные или измененные после рефакторинга
- RBAC упрощен: используется поле `role` в таблице `users` (без таблиц `permissions`)
- Модули объединены для упрощения структуры (business.py вместо отдельных файлов)

### API Endpoints

**Актуальные пути (после рефакторинга):**

```
# Аутентификация
POST   /api/v1/auth/telegram          # Аутентификация через Telegram
GET    /api/v1/auth/me                # Текущий пользователь

# Аналитика и отчеты (analytics.py)
GET    /api/v1/analytics/overview     # KPIs для дашборда
GET    /api/v1/analytics/sales/daily # Продажи по дням
GET    /api/v1/analytics/sales/by-product # Продажи по напиткам
GET    /api/v1/analytics/inventory/balance # Остатки на складе
GET    /api/v1/analytics/owner-report # Отчет собственника (Owner only)

# Бизнес-сущности (business.py - агрегатор модулей)
# Локации
GET    /api/v1/business/locations      # Список локаций
POST   /api/v1/business/locations      # Создать локацию
GET    /api/v1/business/locations/{id} # Детали локации
PUT    /api/v1/business/locations/{id} # Обновить локацию

# Продукты
GET    /api/v1/business/products       # Список продуктов
POST   /api/v1/business/products       # Создать продукт

# Рецепты (drinks)
GET    /api/v1/business/drinks         # Список рецептов
POST   /api/v1/business/drinks         # Создать рецепт
GET    /api/v1/business/drinks/{id}    # Детали рецепта
PUT    /api/v1/business/drinks/{id}    # Обновить рецепт
GET    /api/v1/business/drinks/{id}/cost # Расчет стоимости рецепта

# Ингредиенты
GET    /api/v1/business/ingredients    # Список ингредиентов
POST   /api/v1/business/ingredients    # Создать ингредиент
GET    /api/v1/business/ingredients/{code} # Детали ингредиента
PUT    /api/v1/business/ingredients/{code} # Обновить ингредиент
DELETE /api/v1/business/ingredients/{code} # Удалить ингредиент
PUT    /api/v1/business/ingredients/bulk/update # ⭐ Массовое обновление

# Склад (inventory.py)
GET    /api/v1/business/ingredient-loads # История загрузок
POST   /api/v1/business/ingredient-loads # Добавить загрузку
GET    /api/v1/business/inventory/status # Статус склада

# Маппинг кнопок терминалов (mapping.py)
GET    /api/v1/mapping/button-matrices # Список матриц
POST   /api/v1/mapping/button-matrices # Создать матрицу
GET    /api/v1/mapping/button-matrices/{id} # Детали матрицы
PUT    /api/v1/mapping/button-matrices/{id} # Обновить матрицу
DELETE /api/v1/mapping/button-matrices/{id} # Удалить матрицу
GET    /api/v1/mapping/button-matrices/{id}/items # Элементы матрицы
POST   /api/v1/mapping/button-matrices/{id}/items # Добавить элемент
PUT    /api/v1/mapping/button-matrices/{id}/items/{item_id} # Обновить элемент
DELETE /api/v1/mapping/button-matrices/{id}/items/{item_id} # Удалить элемент
POST   /api/v1/mapping/button-matrices/{id}/assign-terminals # Привязать терминалы

# Переменные расходы (expenses.py)
GET    /api/v1/expenses                # Список расходов
POST   /api/v1/expenses                # Добавить расход

# Пользователи (users.py)
GET    /api/v1/users                   # Список пользователей
POST   /api/v1/users                   # Создать пользователя
GET    /api/v1/users/{id}              # Детали пользователя
PUT    /api/v1/users/{id}              # Обновить пользователя

# Терминалы (terminals.py)
GET    /api/v1/terminals               # Список терминалов

# Транзакции (transactions.py)
GET    /api/v1/transactions            # Список транзакций

# Синхронизация (sync.py)
POST   /api/v1/sync/run                # Запустить синхронизацию
GET    /api/v1/sync/status             # Статус синхронизации
```

**Примечания:**
- ⭐ Помечены новые эндпоинты после рефакторинга
- Пути отличаются от первоначальной документации (более структурированы)
- Batch операции для кнопок реализованы через систему матриц
- Некоторые эндпоинты из первоначальной документации не реализованы (см. IMPROVEMENT_PLAN.md)

---

## 🔧 Middleware и обработка ошибок (после рефакторинга)

### Централизованная обработка ошибок

**Файл:** `app/api/middleware/error_handlers.py`

Реализует глобальные обработчики для:
- `HTTPException` - стандартные HTTP ошибки
- `IntegrityError` - ошибки целостности БД
- `DataError` - ошибки данных БД
- `ValidationError` - ошибки валидации Pydantic
- `BusinessLogicError` - кастомные бизнес-ошибки
- `Exception` - неожиданные ошибки

Все ошибки возвращаются в консистентном формате:
```json
{
  "detail": "Error message",
  "type": "error_type",
  "path": "/api/v1/endpoint"
}
```

### Валидация и общие паттерны

**Файл:** `app/api/middleware/validation.py`

Предоставляет:
- `ValidationMiddleware.validate_entity_exists()` - проверка существования сущности
- `ValidationMiddleware.handle_db_operation()` - обработка операций БД
- `ValidationMiddleware.validate_bulk_operation()` - валидация массовых операций

---

---

## 🔧 Сервисы бизнес-логики (после рефакторинга)

### IngredientService

**Файл:** `app/services/ingredient_service.py`

Функции:
- `bulk_update_ingredients()` - массовое обновление ингредиентов
- `delete_ingredient_safe()` - безопасное удаление с проверкой зависимостей
- `validate_ingredient_data()` - валидация данных ингредиента
- `get_ingredients_paginated()` - пагинация списка ингредиентов

### RecipeService

**Файл:** `app/services/recipe_service.py`

Функции:
- `create_recipe_with_validation()` - создание рецепта с валидацией
- `update_recipe_with_validation()` - обновление рецепта с валидацией
- `calculate_recipe_cost()` - расчет стоимости рецепта
- `get_recipes_with_costs()` - получение рецептов с расчетом стоимости
- `_validate_recipe_data()` - валидация данных рецепта
- `_validate_recipe_items()` - валидация ингредиентов в рецепте

### ExpenseService

**Файл:** `app/services/expense_service.py`

Функции:
- `create_ingredient_load_with_validation()` - создание загрузки с валидацией
- `create_variable_expense_with_validation()` - создание расхода с валидацией
- `get_inventory_status_report()` - отчет о статусе склада
- `get_expense_summary()` - сводка по расходам

---

## ⚠️ Отличия от первоначальной документации

### Упрощения и изменения

1. **RBAC упрощен:** Используется только поле `role` в таблице `users`, без таблиц `permissions`
2. **Модули объединены:** Вместо отдельных файлов используется `business.py` для агрегации
3. **Пути API изменены:** Более структурированные пути (`/api/v1/business/*` вместо `/api/v1/recipes`)
4. **Некоторые эндпоинты не реализованы:** См. `IMPROVEMENT_PLAN.md` для деталей

### Добавлено после рефакторинга

1. ✅ Middleware для валидации и обработки ошибок
2. ✅ Сервисы бизнес-логики (ingredient, recipe, expense)
3. ✅ Разделение API по доменам
4. ✅ Комплексная система тестирования

---

## 🎨 Frontend Architecture (React + TypeScript)

### Технологический стек

- **Framework:** React 18 + TypeScript
- **Build Tool:** Vite
- **Routing:** React Router v6
- **State Management:** Zustand (легковесная альтернатива Redux)
- **API Client:** Axios
- **UI Library:** Ant Design (или Mantine)
- **Charts:** Recharts или Apache ECharts
- **Forms:** React Hook Form + Zod validation
- **Telegram SDK:** @twa-dev/sdk

### Структура проекта

```
frontend/
├── public/
├── src/
│   ├── main.tsx                    # Entry point
│   ├── App.tsx                     # Root component
│   ├── vite-env.d.ts
│   │
│   ├── api/
│   │   ├── client.ts              # Axios instance with interceptors
│   │   ├── auth.ts                # Auth API calls
│   │   ├── overview.ts            # Overview API
│   │   ├── sales.ts               # Sales API
│   │   ├── inventory.ts           # Inventory API
│   │   ├── recipes.ts             # Recipes API
│   │   ├── ingredients.ts         # Ingredients API
│   │   ├── buttons.ts             # Buttons API
│   │   ├── expenses.ts            # Expenses API
│   │   └── ownerReport.ts         # Owner Report API
│   │
│   ├── components/
│   │   ├── layout/
│   │   │   ├── AppLayout.tsx      # Основной layout
│   │   │   ├── Sidebar.tsx        # Боковая панель
│   │   │   ├── Header.tsx         # Шапка с фильтрами
│   │   │   └── TabBar.tsx         # Нижняя навигация (мобильная)
│   │   │
│   │   ├── common/
│   │   │   ├── Card.tsx           # Карточка
│   │   │   ├── Alert.tsx          # Алерт
│   │   │   ├── Button.tsx         # Кнопка
│   │   │   ├── DateRangePicker.tsx # Выбор периода
│   │   │   ├── LocationSelect.tsx # Выбор локации
│   │   │   └── Loading.tsx        # Индикатор загрузки
│   │   │
│   │   ├── charts/
│   │   │   ├── LineChart.tsx      # График линейный
│   │   │   ├── BarChart.tsx       # График столбцы
│   │   │   └── PieChart.tsx       # График круговой
│   │   │
│   │   └── features/
│   │       ├── RecipeForm.tsx     # Форма рецепта
│   │       ├── IngredientForm.tsx # Форма ингредиента
│   │       ├── ExpenseForm.tsx    # Форма расхода
│   │       └── ButtonMapping.tsx  # Привязка кнопок
│   │
│   ├── pages/
│   │   ├── LoginPage.tsx          # Страница логина (Telegram auth)
│   │   ├── OverviewPage.tsx       # 1. Обзор
│   │   ├── SalesPage.tsx          # 2. Продажи
│   │   ├── InventoryPage.tsx      # 3. Склад
│   │   ├── RecipesPage.tsx        # 4. Рецепты
│   │   ├── IngredientsPage.tsx    # 5. Ингредиенты
│   │   ├── ButtonsPage.tsx        # 6. Кнопки терминала
│   │   ├── ExpensesPage.tsx       # 7. Переменные расходы
│   │   ├── OwnerReportPage.tsx    # 8. Отчет собственника
│   │   └── SettingsPage.tsx       # 9. Настройки
│   │
│   ├── store/
│   │   ├── authStore.ts           # Auth state (user, token, role)
│   │   ├── filtersStore.ts        # Фильтры (период, локация)
│   │   └── uiStore.ts             # UI state (sidebar open, etc.)
│   │
│   ├── hooks/
│   │   ├── useAuth.ts             # Auth hook
│   │   ├── useTelegram.ts         # Telegram WebApp hook
│   │   ├── usePermissions.ts      # Проверка прав
│   │   └── useFilters.ts          # Фильтры hook
│   │
│   ├── types/
│   │   ├── api.ts                 # API типы
│   │   ├── models.ts              # Модели данных
│   │   └── telegram.ts            # Telegram типы
│   │
│   ├── utils/
│   │   ├── formatters.ts          # Форматирование (дата, число, валюта)
│   │   ├── validators.ts          # Валидация
│   │   └── constants.ts           # Константы
│   │
│   └── styles/
│       ├── global.css             # Глобальные стили
│       └── theme.ts               # Тема (цвета, шрифты)
│
├── package.json
├── tsconfig.json
├── vite.config.ts
└── .env.example
```

---

## 📱 Экраны админ-панели

### 1. **Экран "Обзор" (Overview)**

**Компоненты:**
- KPI карточки (за выбранный период):
  - Выручка (₽)
  - Количество продаж
  - Валовая прибыль (₽)
  - Валовая маржа (%)
  - Переменные расходы (₽)
  - Чистая прибыль (₽)
  - Чистая маржа (%)
  
- График: Выручка и прибыль по дням
- Список критических алертов (остатки на складе)
- Краткая статистика по локациям

**Права доступа:** Owner ✅, Operator ✅

---

### 2. **Экран "Продажи" (Sales)**

**Компоненты:**
- Графики:
  - Выручка по дням
  - Валовая прибыль по дням
  
- Таблица продаж по напиткам:
  | Напиток | Кол-во | Выручка | Себестоимость | Валовая прибыль | Маржа % |
  |---------|--------|---------|---------------|-----------------|---------|
  | Капучино | 250 | 25,000₽ | 8,500₽ | 16,500₽ | 66% |
  | Латте | 180 | 21,600₽ | 7,200₽ | 14,400₽ | 67% |
  | Эспрессо | 320 | 16,000₽ | 4,800₽ | 11,200₽ | 70% |
  
- Фильтры:
  - Период (дни, недели, месяцы)
  - Локация
  - Терминал

**Права доступа:** Owner ✅, Operator ✅

---

### 3. **Экран "Склад" (Inventory)**

**Вкладки:**

**3.1. Остатки**
- Таблица остатков:
  | Ингредиент | Остаток | Ед.изм. | Расход/день | Осталось дней | Статус |
  |------------|---------|---------|-------------|---------------|--------|
  | Кофе зерно | 5.2 кг | кг | 0.8 кг | 6 дней | 🟡 Предупреждение |
  | Молоко | 12 л | л | 3.5 л | 3 дня | 🔴 Критично |
  
**3.2. Пополнения**
- Список загрузок (последние 50):
  | Дата | Локация | Ингредиент | Количество | Комментарий |
  |------|---------|------------|------------|-------------|
  | 11.01.2026 | Островского | Кофе зерно | 10 кг | Закупка недели |
  
- Кнопка "Добавить загрузку"

**3.3. Расход по дням**
- График расхода ингредиентов по дням
- Выбор ингредиента для детализации

**Права доступа:** Owner ✅, Operator ✅

---

### 4. **Экран "Рецепты" (Recipes)**

**Компоненты:**
- Список рецептов по локации:
  | Рецепт | Локация | Себестоимость | Ингредиенты | Статус |
  |--------|---------|---------------|-------------|--------|
  | Капучино | Островского | 34₽ | Кофе, Молоко | ✅ Активен |
  | Латте | Островского | 40₽ | Кофе, Молоко | ✅ Активен |
  
- Кнопка "Добавить рецепт"
- Кнопка "Клонировать в другую локацию"

**Форма рецепта:**
```
Название: [________]
Локация: [Dropdown]
Привязка к продукту: [Dropdown]

Состав рецепта:
┌─────────────────────────────────────────────┐
│ Ингредиент     | Кол-во | Ед.изм. | [x]    │
├─────────────────────────────────────────────┤
│ Кофе зерно     | 18     | г       | [x]    │
│ Молоко         | 120    | мл      | [x]    │
└─────────────────────────────────────────────┘

[+ Добавить ингредиент]

Себестоимость порции: 34₽

[Сохранить] [Отмена]
```

**Права доступа:** Owner ✅, Operator ✅

---

### 5. **Экран "Ингредиенты" (Ingredients)**

**Компоненты:**
- Справочник ингредиентов:
  | Код | Название | Тип расхода | Ед.изм. | Упаковка | Цена за ед. | Статус |
  |-----|----------|-------------|---------|----------|-------------|--------|
  | COFFEE_BEANS | Кофе зерно | Постоянный | г | 1000 г | 1.9₽/г | ✅ Активен |
  | MILK | Молоко | Постоянный | мл | 1000 мл | 0.08₽/мл | ✅ Активен |
  | SUGAR | Сахар | Переменный | г | 1000 г | 0.05₽/г | ✅ Активен |
  
- Кнопка "Добавить ингредиент"

**Форма ингредиента:**
```
Код: [________]
Название: [________]
Название (RU): [________]

Тип расхода:
  ○ Постоянный (участвует в остатках и себестоимости)
  ○ Переменный (только справочно)

Единица измерения: [Dropdown: г, мл, шт]
Единица (RU): [________]

Упаковка:
  Количество в упаковке: [____] [ед.изм.]
  Цена упаковки: [____] ₽

Расчетная цена за единицу: 1.9 ₽

Пороги алертов:
  Минимальный остаток: [____] [ед.изм.]
  Минимум дней до окончания: [____] дней

[Сохранить] [Отмена]
```

**Права доступа:** Owner ✅, Operator ✅

---

### 6. **Экран "Кнопки терминала" (Buttons Mapping)**

**Компоненты:**
- Выбор локации и терминала
- Таблица кнопок терминала:
  | Machine Item ID | Продукт (Vendista) | Рецепт | Статус |
  |-----------------|---------------------|---------|--------|
  | 1 | Капучино 0.2л | Капучино | ✅ Привязан |
  | 2 | Латте 0.3л | Латте | ✅ Привязан |
  | 3 | Эспрессо | — | ⚠️ Не привязан |
  | 4 | Американо | Американо | ✅ Привязан |
  
- Кнопки:
  - "Привязать по шаблону" (массовая привязка по названиям)
  - "Копировать из другой локации"

**Форма привязки:**
```
Machine Item ID: 3
Продукт (Vendista): Эспрессо

Выберите рецепт:
[Dropdown: список рецептов локации]

[Привязать] [Отмена]
```

**Права доступа:** Owner ✅, Operator ✅

---

### 7. **Экран "Переменные расходы" (Variable Expenses)**

**Вкладки:**

**7.1. Список расходов**
- Таблица расходов:
  | Дата | Локация | Терминал | Категория | Сумма | Комментарий |
  |------|---------|----------|-----------|-------|-------------|
  | 10.01 | Островского | Терм. #1 | Аренда | 15,000₽ | Месячная |
  | 09.01 | Островского | — | Транспорт | 2,500₽ | Доставка |
  
- Кнопка "Добавить расход"

**7.2. Аналитика**
- График расходов по дням
- График по категориям (pie chart)
- Сравнение между локациями

**Форма расхода:**
```
Дата: [Datepicker]
Локация: [Dropdown]
Терминал: [Dropdown (опционально)]

Категория: [Dropdown]
  - Аренда
  - Транспорт
  - Обслуживание
  - Салфетки/стаканы
  - Прочее

Сумма: [____] ₽
Комментарий: [________]

[Создан пользователем]: Ivan Ivanov

[Сохранить] [Отмена]
```

**Права доступа:** Owner ✅, Operator ✅

---

### 8. **Экран "Отчет собственника" (Owner Report)**

**Компоненты:**

**8.1. Основные метрики (за период)**
- KPI карточки:
  - Выручка (₽)
  - Кол-во продаж
  - Средний чек (₽)
  - COGS (себестоимость постоянных ингредиентов) (₽)
  - Валовая прибыль (₽)
  - Валовая маржа (%)
  - Переменные расходы (₽)
  - Чистая прибыль (₽)
  - Чистая маржа (%)

**8.2. Табличная часть**

Вкладки:
- По дням
- По напиткам
- По локациям
- По терминалам

Пример таблицы "По дням":
| Дата | Выручка | COGS | Валовая прибыль | Переменные расходы | Чистая прибыль | Чистая маржа % |
|------|---------|------|-----------------|---------------------|----------------|----------------|
| 11.01 | 45,000₽ | 15,000₽ | 30,000₽ | 5,000₽ | 25,000₽ | 56% |
| 10.01 | 42,000₽ | 14,000₽ | 28,000₽ | 3,500₽ | 24,500₽ | 58% |

**8.3. Блок "Что сделать" (Issues)**
- Несвязанные Machine Item ID (продажи без рецепта):
  ```
  ⚠️ Терминал #178428, Machine Item 5: 25 продаж за период
      Продукт: "Капучино XL"
      Действие: [Привязать к рецепту]
  ```

- Ингредиенты без себестоимости:
  ```
  ⚠️ Ингредиент "Сироп ваниль": отсутствует цена упаковки
      Действие: [Добавить цену]
  ```

- Критичные остатки:
  ```
  🔴 Молоко: осталось 2.5 л (< 3 дней)
      Локация: Островского
      Действие: [Добавить загрузку]
  ```

**Права доступа:** Owner ✅, Operator ❌

---

### 9. **Экран "Настройки" (Settings)**

**Вкладки:**

**9.1. Пользователи**
- Список пользователей:
  | Telegram ID | Имя | Роль | Статус | Дата добавления |
  |-------------|-----|------|--------|-----------------|
  | 123456789 | Ivan Ivanov | Owner | ✅ Активен | 01.01.2026 |
  | 987654321 | Petr Petrov | Operator | ✅ Активен | 05.01.2026 |
  
- Кнопка "Добавить пользователя"

**9.2. Категории расходов**
- Справочник категорий переменных расходов
- Возможность добавления/редактирования

**9.3. Маппинг локаций/терминалов**
- Таблица терминалов:
  | Terminal ID | Terminal Comment (Vendista) | Имя вручную | Локация |
  |-------------|------------------------------|-------------|---------|
  | 145912 | Островского Терм#1 | — | Островского |
  | 178428 | ЦУМ Точка2 | ЦУМ 2-й этаж | ЦУМ |
  
- Приоритет отображения:
  1. Имя вручную (если задано)
  2. Terminal Comment
  3. Fallback: "Терминал #[ID]"

**Права доступа:** Owner ✅, Operator ❌

---

## 🔄 Ключевые бизнес-правила

### Расчет остатков склада
```python
# Остаток = Сумма загрузок - Расход по продажам (только по постоянным ингредиентам)

balance = (
    SELECT SUM(qty_loaded) FROM ingredient_loads WHERE ingredient_code = ?
) - (
    SELECT SUM(recipe_items.qty_per_unit * tx_count)
    FROM transactions
    JOIN recipes ON recipes.product_external_id = transactions.product_id
    JOIN recipe_items ON recipe_items.drink_id = recipes.drink_id
    WHERE recipe_items.ingredient_code = ?
      AND ingredients.expense_kind = 'stock_tracked'  -- только постоянные
)
```

### Расчет себестоимости напитка (COGS)
```python
# Себестоимость = Сумма (количество ингредиента × цена за единицу)
# Только постоянные ингредиенты (expense_kind = 'stock_tracked')

cogs_per_drink = SUM(
    recipe_items.qty_per_unit * ingredients.unit_cost_rub
    WHERE ingredients.expense_kind = 'stock_tracked'
)
```

### Расчет чистой прибыли
```python
# Валовая прибыль = Выручка - COGS (себестоимость постоянных ингредиентов)
gross_profit = revenue - cogs

# Чистая прибыль = Валовая прибыль - Переменные расходы
net_profit = gross_profit - variable_expenses

# Чистая маржа = (Чистая прибыль / Выручка) × 100%
net_margin_pct = (net_profit / revenue) * 100
```

### Обработка напитков без рецепта
```python
# Если у напитка нет рецепта:
# 1. Помечаем как "без рецепта" в отчетах
# 2. COGS = 0 (или null)
# 3. Маржинальность = null (не считается)
# 4. Добавляем в список проблем "Что сделать"
```

### Алерты по остаткам
```python
# Критичный алерт:
if qty_balance <= alert_threshold:
    alert_level = 'LOW_STOCK'
    
# Предупреждение:
if days_left <= alert_days_threshold:
    alert_level = 'DAYS_LEFT'
    
# Расчет дней до окончания:
days_left = qty_balance / avg_daily_usage_7d
```

---

## 🚀 План разработки (Этапы)

### **Этап 1: Инфраструктура и аутентификация** (1 неделя)

✅ Задачи:
1. Создать GitHub репозиторий `vending-admin-v2`
2. Настроить Backend (FastAPI):
   - Структура проекта
   - Docker + PostgreSQL
   - Alembic migrations
3. Реализовать Telegram Auth:
   - Middleware для валидации initData
   - JWT токены
   - Таблица `users` и RBAC
4. Настроить Frontend (React + Vite):
   - Структура проекта
   - Telegram Mini App SDK
   - Axios client с interceptors
5. Базовый LoginPage с Telegram auth

**Результат:** Работающая аутентификация через Telegram, JWT токены, роли Owner/Operator

---

### **Этап 2: Синхронизация с Vendista API** (3-4 дня)

✅ Задачи:
1. Перенести логику синхронизации из старого проекта:
   - `vendista_terminals`
   - `vendista_tx_raw`
   - `sync_state`
2. Создать сервис `VendistaSync` для автоматической синхронизации
3. Настроить cron-задачу для регулярной синхронизации

**Результат:** Данные Vendista автоматически синхронизируются в новую БД

---

### **Этап 3: Основные сущности и CRUD** (1 неделя)

✅ Задачи:
1. Создать модели и миграции:
   - `locations`, `terminals`
   - `products`, `drinks`
   - `ingredients`
   - `recipes`, `drink_items` (состав рецепта)
   - `location_drink_map` (привязки)
2. Реализовать CRUD API для:
   - Ингредиентов
   - Рецептов
   - Привязок кнопок
3. Создать UI:
   - Страница "Ингредиенты" (список + форма)
   - Страница "Рецепты" (список + форма)
   - Страница "Кнопки терминала"

**Результат:** Можно создавать и редактировать ингредиенты, рецепты, привязывать кнопки

---

### **Этап 4: Склад и загрузки** (3-4 дня)

✅ Задачи:
1. Таблицы:
   - `ingredient_loads` (загрузки)
2. Представления:
   - `vw_ingredient_balance` (остатки)
   - `vw_ingredient_usage_daily` (расход по дням)
   - `vw_ingredient_alerts` (алерты)
3. API эндпоинты для склада
4. UI страница "Склад":
   - Вкладка "Остатки"
   - Вкладка "Пополнения" + форма загрузки
   - Вкладка "Расход по дням"

**Результат:** Работающая система учета склада с остатками и алертами

---

### **Этап 5: Продажи и KPI** (1 неделя)

✅ Задачи:
1. Представления:
   - `vw_tx_cogs` (COGS и валовая прибыль по транзакциям)
   - `vw_kpi_daily` (KPI по дням)
   - `vw_kpi_product` (KPI по напиткам)
2. API эндпоинты для продаж
3. UI страница "Продажи":
   - Графики (выручка, прибыль)
   - Таблица по напиткам
4. UI страница "Обзор":
   - KPI карточки
   - График
   - Алерты

**Результат:** Дашборд с KPI и страница продаж с аналитикой

---

### **Этап 6: Переменные расходы** (2-3 дня)

✅ Задачи:
1. Таблицы:
   - `variable_expenses`
   - `expense_categories`
2. Представления:
   - `vw_variable_expenses_daily`
   - `vw_variable_expenses_by_category`
3. API эндпоинты для расходов
4. UI страница "Переменные расходы":
   - Список + форма добавления
   - Вкладка "Аналитика" с графиками

**Результат:** Можно вводить переменные расходы и анализировать их

---

### **Этап 7: Отчет собственника** (3-4 дня)

✅ Задачи:
1. Представления:
   - `vw_owner_report_daily` (ежедневная сводка с чистой прибылью)
   - `vw_owner_report_issues` (список проблем)
2. API эндпоинты для отчета собственника
3. UI страница "Отчет собственника":
   - KPI карточки (с чистой прибылью)
   - Таблицы (по дням/напиткам/локациям)
   - Блок "Что сделать" (проблемы)

**Результат:** Полный отчет собственника с чистой прибылью и списком проблем

---

### **Этап 8: Настройки и администрирование** (2-3 дня)

✅ Задачи:
1. API эндпоинты:
   - Управление пользователями
   - Категории расходов
   - Маппинг терминалов
2. UI страница "Настройки":
   - Вкладка "Пользователи"
   - Вкладка "Категории расходов"
   - Вкладка "Терминалы"

**Результат:** Owner может управлять пользователями и настройками системы

---

### **Этап 9: Тестирование и деплой** (1 неделя)

✅ Задачи:
1. Написать тесты:
   - Unit tests для CRUD
   - Integration tests для API
   - E2E tests для критичных флоу
2. Настроить CI/CD (GitHub Actions):
   - Автоматические тесты
   - Деплой на production
3. Документация:
   - README.md
   - API документация (OpenAPI/Swagger)
   - Инструкция по деплою
4. Деплой на production сервер

**Результат:** Готовый production-ready продукт

---

## 📊 Итоговый функционал

### Для **Собственника** (Owner):
✅ Полный контроль над бизнесом:
- Видит все финансовые метрики (выручка, маржа, чистая прибыль)
- Управляет пользователями и их правами
- Настраивает систему (категории расходов, маппинг терминалов)
- Получает список проблем для решения (несвязанные продажи, критичные остатки)
- Анализирует эффективность по локациям и напиткам

### Для **Оператора** (Operator):
✅ Оперативное управление:
- Создает и редактирует рецепты
- Управляет ингредиентами (добавление, редактирование себестоимости)
- Привязывает кнопки терминалов к рецептам
- Вводит загрузки склада
- Вводит переменные расходы
- Видит текущие продажи и остатки

### Общие возможности:
✅ Современный UX:
- Telegram Mini App (нативное ощущение в Telegram)
- Адаптивный дизайн (десктоп + мобильная версия)
- Быстрая загрузка данных
- Интерактивные графики (ECharts)
- Фильтры (период, локация, терминал)
- Темная/светлая тема (следуя Telegram)

---

## 🔧 Технические детали

### Backend Stack
- **Python 3.12+**
- **FastAPI** (async/await, высокая производительность)
- **SQLAlchemy 2.0** (ORM)
- **Alembic** (миграции)
- **PostgreSQL 16**
- **Pydantic** (валидация данных)
- **python-jose** (JWT токены)
- **httpx** (async HTTP client для Vendista API)

### Frontend Stack
- **React 18** + **TypeScript 5**
- **Vite** (быстрый build)
- **React Router v6** (роутинг)
- **Zustand** (state management)
- **Ant Design** или **Mantine** (UI компоненты)
- **Recharts** или **ECharts** (графики)
- **React Hook Form** + **Zod** (формы)
- **Axios** (HTTP client)
- **@twa-dev/sdk** (Telegram WebApp SDK)

### DevOps
- **Docker** + **Docker Compose**
- **GitHub Actions** (CI/CD)
- **Caddy** (reverse proxy)
- **systemd** (управление сервисами)

---

## 🎯 Ключевые преимущества новой архитектуры

1. ✅ **Современная аутентификация** через Telegram (без паролей, безопасно)
2. ✅ **Role-Based Access Control** (гибкое управление правами)
3. ✅ **Чистая архитектура** (легко расширять и поддерживать)
4. ✅ **TypeScript** на фронтенде (меньше багов, лучший DX)
5. ✅ **Telegram Mini App** (нативное ощущение, не нужна установка)
6. ✅ **Production-ready** (тесты, CI/CD, мониторинг)
7. ✅ **Полная документация** (API, README, инструкции)

---

## 📝 Следующие шаги

1. ✅ Создать репозиторий на GitHub
2. ✅ Утвердить архитектуру с заказчиком
3. ✅ Начать разработку с Этапа 1 (Инфраструктура)
4. ✅ Настроить старый проект как справочник (read-only)

---

**Автор:** AI Developer (Claude)  
**Дата:** 12.01.2026  
**Версия:** 1.0
